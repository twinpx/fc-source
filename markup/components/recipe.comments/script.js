!function(a){"use strict";function b(a,b){function c(){d(),i.$name=i.$elem.find("div.new_file_name"),i.$input.change(function(){e()})}function d(){i.$elem.html('<div class="browse_button" title="Выбрать файл"></div><div class="blocker"></div><div class="new_file_name"></div>'),i.$elem.find(".browse_button").after(i.$input)}function e(){var a=h(),b=g(a);f(b)?(i.$name.text(a),i.$name.removeClass("i-attention")):(i.$name.text(j.messages.wrongExtention),i.$name.addClass("i-attention")),i.$name.css({display:"block"})}function f(a){for(var b=!1,c=0;c<j.extentions.length;c++)a.toLowerCase()==j.extentions[c]&&(b=!0);return b}function g(a){var b=/.*\.(.*)/,c=a.replace(b,"$1");return c}function h(){var a=i.$input.val(),b=/.*\\(.*)/,c=a.replace(b,"$1"),d=/.*\/(.*)/;return c=c.replace(d,"$1"),c.length>18&&(c="..."+c.substr(c.length-16,16)),c}var i=this;i.$elem=a,i.$input=i.$elem.find(":file");var j={},b=b||{};j.extentions=b.extentions||["jpg","jpeg"],j.messages=b.maessages||{wrongExtention:"Загружайте изображения в jpeg формате"},c()}a(function(){function c(){a(function(){a(".b-recipe-comments").each(function(){new g(this)}),a("#b-comment-form").each(function(){new f(this)}),e()})}function d(){for(var a={},b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");a[d[0]]="undefined"==typeof d[1]?"":d[1]}return a}function e(){var b=d();b.commentid&&b.commentid.length&&(a("#liketn_"+b.commentid+":eq(0)").click(),setTimeout(function(){a.scrollTo(a("[data-id="+b.commentid+"]").offset().top-100,500)},1e3))}function f(c){function d(){e(),f()}function e(){m.$elem=a(c),m.$elem.data("CommentForm",m)}function f(){m.$elem.delegate("form","submit",j).delegate(".b-admin-buttons .b-delete-icon","click",a(".b-recipe-comments").data("RecipeComments").clickDelete),m.$elem.find("[type=submit]").click(g)}function g(b){b.preventDefault(),a(this).closest("form").submit()}function j(c){function d(a){g.removeClass("i-preloader"),a&&a.error?f.find(".error_message").text(a.error):(k(f),e(a))}function e(c){setTimeout(function(){f.find("[type=submit]").removeClass("i-preload");var d=a('<div style="display:none;"></div>');d.html(i(c)),a(".b-recipe-comments").prepend(d),d.find(".input_file").each(function(){new b(a(this))}),l(d),a.scrollTo(a("#b-comments").offset().top-100,500,function(){d.css({opacity:0}).show().animate({opacity:1},500)}),window.upButton.styleElements()},500)}c.preventDefault();var f=a(this),g=f.find("[type=submit]");n(f)&&!g.hasClass("i-preloader")&&(g.addClass("i-preloader"),a.ajax({url:f.attr("action"),type:f.attr("method"),dataType:"json",data:f.serialize(),async:!1,success:d,error:ajaxError}))}function k(a){if(a.find("textarea").val("").end().find(".error_message").text(""),""!=a.find(".b-comment-form__photo__url").val()){var b=a.find(":file").closest(".b-form-field");h(b,"comment")}}var m=this;d()}function g(c){function d(){e(),f(),l()}function e(){A.$elem=a(c),A.$elem.data("RecipeComments",A),A.$replyForm=A.$elem.find("#b-rc__reply-form"),A.$editForm=A.$elem.find("#b-rc__edit-form"),A.$getMoreButton=A.$elem.find(".b-more-button a"),A.commentsPerPage=5,A.page=1}function f(){A.$getMoreButton.click(y),A.$elem.delegate(".b-rc__props__reply a","click",g).delegate(".b-rc__admin-buttons .b-edit-icon","click",o).delegate(".b-close-icon","click",p).delegate("button[type=submit]","click",q).delegate(".b-textarea","keyup",r).delegate(".b-like-icon__type-button","click",t).delegate(".b-admin-buttons .b-delete-icon","click",u).delegate("form","submit",v).delegate(".b-rc__item__content__text__img","click",w).find(".b-textarea").resizeTextarea()}function g(b){function c(){A.$elem.find(".i-edit").removeClass("i-edit")}function d(){function b(){A.$elem.find(".i-reply").each(function(){a(this).removeClass("i-reply").find(".b-rc__props__reply a").text("Ответить")}),e()}A.$replyForm.is(":visible")?A.$replyForm.slideUp(300,b):b()}function e(){A.$replyForm.hide().insertAfter(g.closest(".b-rc__item__content")).slideDown("middle").find(".b-textarea").val("").resizeTextarea(),setTimeout(function(){A.$replyForm.find(".b-textarea").focus()},100);var a=h.attr("data-id");A.$replyForm.find("input[name='rId']").val(a),f()}function f(){g.text("Скрыть"),h.addClass("i-reply")}b.preventDefault();var g=a(this),h=g.closest(".b-rc__item");return h.hasClass("i-reply")?void A.$replyForm.find(".b-close-icon").click():(c(),void d())}function o(b){b.preventDefault();var c=a(this).closest(".b-rc__item");c.addClass("i-edit")}function p(b){function c(a){A.$replyForm.closest(".b-rc__item").removeClass("i-reply").find(".b-rc__props__reply a").text("Ответить"),A.$replyForm.slideUp("middle",function(){A.$replyForm.find(".b-form-field").removeClass("i-attention")}),a.preventDefault()}function d(a){a.preventDefault();var b=e.closest(".b-rc__item");b.removeClass("i-edit").find(".b-form-field").removeClass("i-attention")}var e=a(this);0!==e.closest("#b-rc__reply-form").length?c(b):e.hasClass("b-rc__item__close")&&d(b)}function q(b){b.preventDefault(),a(this).closest("form").submit()}function r(b){if(b.ctrlKey&&13==b.keyCode){if(""==a(this).val())return!1;A.$replyForm.find("form").submit()}}function s(){return 1===a("#b-comment-form .b-rc__item.i-foodclub").length?!1:!0}function t(b){function c(b){var c;return a.ajax({type:"GET",dataType:"text",url:f,async:!1,data:"id="+e.closest(".b-rc__item").attr("data-id")+"&action="+b,success:function(a){c=a}}),c}function d(a,b){b&&"0"!=b||(b=""),a.siblings(".b-like-num").text(b),a.toggleClass("b-like-icon__type-active")}if(!s())return document.getElementById("authModal")&&(a("#authModal form").each(function(){a(this).find("div:first").append('<input type="hidden" name="commentLikeFlag" value="Y">'),Cookies.set("likeComment",a(this).closest(".b-rc__item").data("id"))}),a(".b-header__auth-button").click()),!1;b.preventDefault();var e=a(this),f=e.attr("data-ajax-url"),g="like";e.hasClass("b-like-icon__type-active")&&(g="dislike");var h=c(g);d(e,h)}function u(c,d){function e(b){function c(){var a=d.find(".b-form__photo-block__img img").attr("data-id"),b={id:d.attr("data-id"),sessid:d.closest(".b-recipe-comments").attr("data-sessId")};return a&&(b.imgId=a),b}var d=b.closest(".b-rc__item"),e=c();a.ajax({url:A.$elem.attr("data-delete-action"),type:A.$elem.attr("data-delete-method"),data:e,success:function(){d.parent().is(".b-rc__block")?b.closest(".b-rc__block").remove():d.remove()},error:ajaxError})}function f(c){var d=c.closest(".b-rc__item");a.ajax({url:A.$elem.attr("data-delete-photo-action"),type:A.$elem.attr("data-delete-photo-method"),data:"id="+d.attr("data-id")+"&imgId="+d.find(".b-form__photo-block__img img").attr("data-id"),success:function(){var e=d.attr("data-id"),f=c.closest(".b-form__photo-block").empty(),g=k({id:e,type:"edit"},"file-input-template");if(f.html(g),f.find(".input_file").each(function(){new b(a(this))}),l(f),0!==d.find(".b-rc__item__content__text__content").length){var h=d.find(".b-rc__item__content__text__content").html();d.find(".b-rc__item__content__text").html(h)}},error:ajaxError})}function g(b,c){var d=b.closest(".b-form-field");a.ajax({url:A.$elem.attr("data-delete-photo-action"),type:A.$elem.attr("data-delete-photo-method"),data:"src="+d.find(".b-form__photo-block__img img").attr("src"),success:function(){h(d,c)},error:ajaxError})}if(d=d||this,c.preventDefault(),confirm(a(d).attr("title")+"?"))if(a(d).closest(".b-admin-buttons").hasClass("b-rc__admin-buttons"))e(a(d));else{var i=a(d).closest(".b-form-field");0!==i.closest(".b-rc-edit-form").length?f(a(d)):0!==i.closest("#b-rc__reply-form").length?g(a(d),"reply"):0!==i.closest("#b-comment-form").length&&g(a(d),"comment")}return!1}function v(c){function d(a){i.removeClass("i-preloader");var b=g.closest(".b-rc__item");b.hasClass("i-edit")?e(a,b):b.hasClass("i-reply")&&f(a,b)}function e(a,b){if(b.removeClass("i-edit"),a&&a.image&&a.image.src&&""!=a.image.src)var c="<div style=\"background-image: url('"+a.image.src+'\');" data-id="'+a.image.id+'" class="b-rc__item__content__text__img"></div><div class="b-rc__item__content__text__content">'+a.text.html+'</div><div class="i-clearfix"></div>';else c=a.text.html;if(b.children(".b-rc__item__content").find(".b-rc__item__content__text").empty().html(c).end().find(".b-form__text-block textarea").val(a.text.text),a.image&&a.image.src){b.find(".b-rc-edit-form .b-image-icon__photo-url").val(a.image.src);var d=b.find(".b-rc-edit-form .b-form__photo-block__img");""!=d.text()?b.find(".b-rc-edit-form .b-form__photo-block__img").data({id:a.image.id}).css({backgroundImage:"url('"+a.image.src+"')"}):m({result:{files:[{url:a.image.src}]}},b.find(".b-rc-edit-form input[id*=fileupload]"),"edit")}a&&a.date&&b.find(".b-rc__props__date").text(a.date)}function f(c,d){c.root=d.attr("data-id");var e=a(j(c));0===d.parent().find(".b-rc__reply-block").length&&d.after('<div class="b-rc__reply-block"></div>'),d.parent().find(".b-rc__reply-block").prepend(e),d.find(".b-rc__reply-form__close").click(),e.find(".input_file").each(function(){new b(a(this))}),l(e);var f=A.$replyForm.find(".b-form__photo-block");h(f,"reply")}c.preventDefault();var g=a(this),i=g.find("[type=submit]");if(n(g)&&!i.hasClass("i-preloader")){i.addClass("i-preloader");var k=g.attr("action"),o=g.attr("method");k&&""!=k||(k=A.$elem.attr("data-edit-form-action")),o&&""!=o||(o=A.$elem.attr("data-edit-form-method")),a.ajax({url:k,type:o,dataType:"json",data:g.serialize(),async:!1,success:d,error:ajaxError})}}function w(){var b=a(this),c=b.closest(".b-rc__item"),d=new Image;if(d.src=b.css("backgroundImage").substring(5,b.css("backgroundImage").length-2),b.hasClass("b-rc__item__content__text__img__type_block")){if(b.css({width:"65px",height:"65px",margin:"0 12px 0 0"}).removeClass("b-rc__item__content__text__img__type_block"),c.data("scroll")&&""!=c.data("scroll"))var e=c.data("scroll");else e=parseInt(b.closest(".b-rc__item").offset().top,10)-parseInt(a("#top_panel").height(),10);a.scrollTo(e,500)}else{b.addClass("b-rc__item__content__text__img__type_block");var f=d.width,g=d.height;d.width>b.closest(".b-rc__item__content__text").width()&&(f=b.closest(".b-rc__item__content__text").width(),g=Math.floor(d.height*f/d.width)),b.css({width:f,height:g,margin:"0 0 15px"}),a.scrollTo(),c.data({scroll:x()}),a.scrollTo(parseInt(b.closest(".b-rc__item").offset().top,10)-parseInt(a("#top_panel").height(),10),500)}}function x(){return window.pageYOffset||document.documentElement.scrollTop}function y(){return a.ajax({url:"/php/get_more_comments.php",dataType:"json",data:{page:++A.page},beforeSend:function(){A.$getMoreButton.parent().addClass("i-preload")},success:function(b){setTimeout(function(){A.$getMoreButton.parent().removeClass("i-preload");for(var c=a('<div style="display:none;"></div>'),d=0;d<b.comments.length;d++)c.append(i(b.comments[d]));A.$getMoreButton.parent().before(c),c.css({opacity:0}).show().animate({opacity:1},500),a.scrollTo(c,1e3),z(),window.upButton.styleElements()},500)},error:ajaxError}),!1}function z(){var a=parseInt(A.$getMoreButton.attr("data-pages"),10);a--,A.$getMoreButton.attr({"data-pages":a}),1==a&&A.$getMoreButton.hide()}var A=this;d(),this.clickDelete=function(a){u(a,this),a.preventDefault(),a.stopPropagation()}}function h(c,d){c.empty();var e=k({id:"",type:d},"file-input-template");c.html(e),c.find(".input_file").each(function(){new b(a(this))}),l(c)}function i(b){var c={id:"",rId:"",sessid:a(".b-recipe-comments").attr("data-sessId"),author:{href:"",src:"",name:""},text:{html:"",text:""},image:{},likeNum:0,mine:!1,date:"",reply:[]};b=a.extend(c,b);for(var d=document.getElementById("comment-template").innerHTML,e=tmpl(d),f=a(e(b)),g=0;g<b.reply.length;g++)b.reply[g].root=b.id,f.append(j(b.reply[g]));return f}function j(b){b.cId=b.id;var c={id:"",cId:"",rId:"",sessid:a(".b-recipe-comments").attr("data-sessId"),root:"",image:{},text:{html:"",text:""},author:{href:"",src:"",name:""},mine:!1,date:"",likeNum:0};b=a.extend(c,b);var d=document.getElementById("reply-template").innerHTML,e=tmpl(d);return e(b)}function k(a,b){a.id||(a.id="");var c=document.getElementById(b).innerHTML,d=tmpl(c);return d(a)}function l(c){function d(a,b){var c={maxNumberOfFiles:"Загружайте только одну фотографию",acceptFileTypes:"Загружайте фотографии формата jpg, jpeg, gif, png",maxFileSize:"Размер файла превышает 500 кб"},d=c[a];alert(d),b.closest(".b-form-field").removeClass("i-progress").removeClass("i-hover")}function e(c,d,e){a.each(d.result.files,function(c,d){var f=k({id:"",url:d.url,type:"comment"},"photo-template"),g=e.closest(".b-form-field");g.html(f),g.find(".input_file").each(function(){new b(a(this))}),l(g)})}c=c||a("#b-comments"),c.find("input[id*=fileupload]").each(function(){var b=a(this),c=b.attr("id"),f=b.attr("data-ajax-url");b.fileupload({url:f,dataType:"json",add:function(a,c){c.files.length>1?d("maxNumberOfFiles",b):/(\.|\/)(gif|jpe?g|png)$/i.test(c.files[0].type)?c.files[0].size>5e5?d("maxFileSize",b):c.submit():d("acceptFileTypes",b)},progress:function(){a("#"+c).closest(".b-form-field").addClass("i-progress")},done:function(b,d){var f=a("#"+c);if(f.closest(".b-form-field").removeClass("i-progress").removeClass("i-hover"),0!==f.closest("#b-comment-form").length)e(b,d,f);else{if(0!==f.closest(".b-rc-edit-form").length)var g="edit";0!==f.closest("#b-rc__reply-form").length&&(g="reply"),m(d,f,g)}}})})}function m(c,d,e){a.each(c.result.files,function(c,f){var g=k({id:d.closest(".b-rc__item").attr("data-id"),url:f.url,type:e},"photo-template"),h=d.closest(".b-form-field");h.html(g),h.find(".input_file").each(function(){new b(a(this))}),l(h)})}function n(b){var c,d=!0;return b.find("[required]").each(function(){var b=a(this);""==a.trim(b.val())?(d=!1,b.closest(".b-form-field").addClass("i-attention"),c||(b.focus(),c=b)):b.closest(".b-form-field").removeClass("i-attention")}),b.find(":file").each(function(){a(this).closest(".b-form-field").hasClass("i-progress")&&(d=!1)}),d}var o=!1;a(window).bind("scroll",function(){if(a(".b-recipe-comments").is(":empty")){var b=a(document).scrollTop()+parseInt(window.screen.height)-150;a(".b-recipe-comments").each(function(){var d=a(this);d.offset().top<b&&(o||(o=!0,a.ajax({url:d.data("load-action"),type:d.data("load-method"),dataType:"html",success:function(a){d.html(a),c()},error:function(a,b,c){o=!1,window.console&&(console.log(a),console.log(b),console.log(c))}})))})}}),a("#b-comment-form .b-textarea").resizeTextarea()})}(jQuery);